{% extends "format.html" %}
{% load static %}
{% load filter %}

{% block title %}StocksEra | Reddit Ticker{% endblock %}

{% block additional_script %}
<link rel="stylesheet" href="{% static 'style/reddit_ticker_analysis.css' %}">
<script src="{% static 'javascript/reddit_ticker_analysis.js' %}"></script>
{% endblock %}

{% block onload_properties%}restore_dark_mode();rank_chart(){% endblock %}

{% block main_nav %}
    <div class="ticker-wrap">
        <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
            "symbols": [
            {
              "proName": "FOREXCOM:SPXUSD",
              "title": "S&P 500"
            },
            {
              "proName": "FOREXCOM:NSXUSD",
              "title": "Nasdaq 100"
            },
            {
              "description": "Apple",
              "proName": "NASDAQ:AAPL"
            },
            {
              "description": "Tesla, Inc",
              "proName": "NASDAQ:TSLA"
            },
            {
              "description": "Nvidia",
              "proName": "NASDAQ:NVDA"
            },
            {
              "description": "Microsoft",
              "proName": "NASDAQ:MSFT"
            },
            {
              "description": "GameStop",
              "proName": "NYSE:GME"
            },
            {
              "description": "AMC",
              "proName": "NYSE:AMC"
            },
            {
              "description": "Blackberry",
              "proName": "NYSE:BB"
            }
            ],
            "showSymbolLogo": true,
            "colorTheme": "light",
            "isTransparent": true,
            "displayMode": "regular",
            "locale": "en"
            }
            </script>
        </div>
    </div>
{% endblock %}

{% block main_content %}
    <div class="instructions">
        <h2>Reddit Ticker Analysis</h2>
        <p>View ranking of popular tickers in Reddit over time and compare it with its price.</p>
    </div>

    <div class="reddit_ticker_analysis">
        <form action="" method="GET" autocomplete="off">
            <select name="subreddit" onchange="this.form.submit()">
                <option>Subreddit: {{subreddit}}</option>
                <option value="wallstreetbets">Wall Street Bets</option>
                <option value="stocks">Stocks</option>
                <option value="stockmarket">Stock Market</option>
                <option value="options">Options</option>
                <option value="investing">Investing</option>
                <option value="pennystocks">Pennystocks</option>
            </select>
            <input placeholder="TICKER: " name="quote" value="{{ticker_selected}}">
            <button>SEARCH</button>
        </form>

        <div id="ticker_basic_stats"></div>

        <div id="more_info_div">
            <a class="more_info_btn" href="{% url 'ticker' %}?quote={{ticker_selected}}" onclick="clickAndDisable(this);">Analysis</a>
            <a class="more_info_btn" href="{% url 'options' %}?quote={{ticker_selected}}" onclick="clickAndDisable(this);">Options</a>
            <a class="more_info_btn" href="{% url 'short_volume' %}?quote={{ticker_selected}}" onclick="clickAndDisable(this);">Short Vol</a>
            <a class="more_info_btn" href="{% url 'failure_to_deliver' %}?quote={{ticker_selected}}" onclick="clickAndDisable(this);">FTD</a>
        </div>

        <h2>Ranking of ${{ticker_selected}} in r/{{subreddit}} over time</h2>
        <div class="ranking_description">The lower the ranking, the more popular the ticker.</div>

        <div class="chart-container">
            <canvas id="rank_chart"></canvas>
        </div>

        <table id="reddit_table" style="display:none">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>48H Score</th>
                    <th>Previous Close</th>
                    <th>Date (DD/MM/YYYY)</th>
                </tr>
            </thead>
            <tbody>
                {% for rank in ranking %}
                    <tr>
                        <td>{{rank.0}}</td>
                        <td>{{rank.1}}</td>
                        <td>{{rank.2}}</td>
                        <td>{{rank.3}}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block bottom_script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
<!--Hack to convert python variables to javascript-->
var None = "N/A", False = false; True = true;
var information = {{information|safe}};

var latest_price = information["regularMarketPrice"]
var mkt_close = information["previousClose"]

<!--Function to check that dictionary has a key-->
function check_stats(property) {
    if (information.hasOwnProperty(property) == true) {
        property_name = information[property]
    }
    else {
        property_name = "N/A"
    }
    return property_name
}

<!--Function to check that if the value in a dictionary is a long number, add commas for easy reading-->
function check_if_num(property) {
    property_name = information[property]
    if (typeof(property_name) == "number") {
        property_name= Number(property_name).toLocaleString()
    }
    else {
        property_name = "N/A"
    }
    return property_name
}

<!--If ticker does not have an image, show a default image-->
var img = `https://g.foolcdn.com/art/companylogos/mark/${information["symbol"]}.png`
var img_code = `<img src="${img}" onerror=this.src="{% static 'images/not_available.svg' %}">`

<!--Code to show price change-->
var price_change = Math.round((latest_price - mkt_close) * 100) / 100
var price_percentage_change = Math.round(((latest_price - mkt_close) / mkt_close) * 10000) / 100
if (price_change > 0) {
    price_change = "+" + String(price_change)
    price_percentage_change = "+" + String(price_percentage_change) + "%"
}
else {
    price_percentage_change = String(price_percentage_change) + "%"
}

if (price_percentage_change.includes("-")) {
    var price_code = `<div class="price_details negative_price">$${latest_price}<br>${price_change} (${price_percentage_change})</div>`
}
else {
    var price_code = `<div class="price_details positive_price">$${latest_price}<br>${price_change} (${price_percentage_change})</div>`
}

<!--Code to display image, full name, symbol, industry and sector-->
var official_name = check_stats("longName");
var sector = check_stats("sector")
var industry = check_stats("industry")

var ticker_basic_stats_code = `
        <div id="img_div">${img_code}</div>
        <div id="ticker_intro">
            <span>${official_name} (${information["symbol"]})</span>
            <br>Sector: <b>${sector}</b><br>Industry: <b>${industry}</b>
        </div>
        ${price_code}`
document.getElementById("ticker_basic_stats").innerHTML = ticker_basic_stats_code;
</script>
{% endblock %}