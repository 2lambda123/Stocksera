{% extends "format.html" %}
{% load static %}
{% load filter %}

{% block title %}StocksEra | Calendar{% endblock %}

{% block additional_script %}
<link rel="stylesheet" href="{% static 'style/earnings_calendar.css' %}">
<script src="{% static 'javascript/earnings_calendar.js' %}"></script>
{% endblock %}

{% block onload_properties%}{% endblock %}

{% block main_nav %}
    <div class="ticker-wrap">
        <div class="ticker">
            {% for name in popular_name_list|length|get_range %}
            <div class="ticker_item">
                <b>{{popular_name_list|index:name}} &#183 {{price_list|index:name|index:0}} <span> {{price_list|index:name|index:1}} ({{price_list|index:name|index:2}}%) </span></b>
            </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block main_content %} 
<div id="top"></div>

<div class="menu">
    <button onclick="sortTicker(this, 0)" class="selected_btn">ALL</button>
    <button onclick="sortTicker(this, 10000000000)">>$10B</button>
    <button onclick="sortTicker(this, 20000000000)">>$20B</button>
    <button onclick="sortTicker(this, 50000000000)">>$50B</button>
    <input type="text" placeholder="Ticker:" autocomplete="off" class="filter_ticker" id="search_ticker" onkeyup="searchTicker()">
    <span>Date: </span>
</div>

<div id="main"></div>

{% endblock %}

{% block bottom_script %}
<script type="text/javascript">
    var earnings_calendar = {{ earnings_calendar|safe }};

    current_date = ""
    earning_date_list = []
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    html_string = "<div>"

    for (earning=0; earning<earnings_calendar.length; earning++) {
        earning_date = earnings_calendar[earning][6];

        if (earning_date != current_date) {
            current_date = earning_date;
            earning_date_list.push(earning_date)
            current_date_count = 0;
            var d = new Date(current_date);
            var dayName = days[d.getDay()];
            html_string += `</div>
                            <div id="${earning_date}"><h2>${earning_date} (${dayName})</h2></div>
                            <div class="earnings_div">`
        }

        mkt_cap = Number(earnings_calendar[earning][2])
        if (mkt_cap < 1000000000) {
            // to round to 2dp
            mkt_cap = String(Math.round(mkt_cap / 10000, 2)) / 100 + "M"
        } 
        else if (mkt_cap >= 1000000000) {
            mkt_cap = String(Math.round(mkt_cap / 10000000, 2)) / 100 + "B"
        }

        eps_est = earnings_calendar[earning][3]
        if (! eps_est.includes("N/A")) {
            if (eps_est.includes("-")) {
                eps_est = eps_est.replace("-", "-$")
            }
            else {
                eps_est = "$" + eps_est
            }
        }
            
        html_string += ` <div class="earnings_container">
                            <a href=""><img src="${earnings_calendar[earning][5]}" onerror=this.src="{% static 'images/not_available.svg' %}" class="company_img"></a>
                            <div><span>Name: </span>${earnings_calendar[earning][0]}</div>
                            <div><span>Ticker: </span>${earnings_calendar[earning][1]}</div>
                            <div><span>Mkt Cap: </span>${mkt_cap}</div>
                            <div><span>EPS Est: </span>${eps_est}</div>
                         </div>`
    }   
    html_string += `</div>`
    document.getElementById("main").innerHTML += html_string;

    earning_date_string = `<select onchange="date_filter()" id="select_date"><option></option>`
    for (earning_date of earning_date_list) {
        earning_date_string += `<option><a href="#${earning_date}">${earning_date}</a></option>`
    }
    earning_date_string += `</select>
                            <span>Sort By: </span>
                            <select>
                                <option>Mkt Cap</option>
                                <option>EPS</option>
                            </select><span id="to_top">
                            <a href="#top">To Top</a></span>`
    document.getElementsByClassName("menu")[0].innerHTML += earning_date_string;
</script>
{% endblock %}


